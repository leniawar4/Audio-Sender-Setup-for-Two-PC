<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>LAN Audio Streamer</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

:root {
    --bg-dark: #07070c;
    --bg-card: rgba(18,18,30,0.7);
    --bg-card-hover: rgba(28,28,44,0.85);
    --bg-elevated: rgba(32,32,56,0.9);

    --border: rgba(255,255,255,0.08);
    --border-hover: rgba(255,255,255,0.16);

    --accent: #7c7cff;
    --accent-hover: #9b9bff;
    --accent-glow: rgba(124,124,255,0.35);

    --success: #22c55e;
    --warning: #facc15;
    --error: #fb7185;

    --text-primary: #f8fafc;
    --text-secondary: #c7c9ff;
    --text-muted: #8b8fd9;

    --gradient-1: linear-gradient(
        135deg,
        #7c7cff 0%,
        #a78bfa 50%,
        #22d3ee 100%
    );

    --gradient-2: linear-gradient(
        135deg,
        #22c55e 0%,
        #4ade80 100%
    );
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', system-ui, sans-serif;
    background: var(--bg-dark);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
}

/* Background */
.bg-gradient {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
}

.bg-gradient::before {
    content: '';
    position: absolute;
    inset: -50%;
    background:
        radial-gradient(ellipse at 20% 10%, rgba(124,124,255,0.12), transparent 50%),
        radial-gradient(ellipse at 80% 90%, rgba(34,211,238,0.10), transparent 50%);
    animation: bgMove 20s ease-in-out infinite;
}

@keyframes bgMove {
    0%,100% { transform: translate(0,0); }
    50% { transform: translate(-4%, -4%); }
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

.grid-overlay {
    position: fixed;
    inset: 0;
    background-image:
        linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
    background-size: 48px 48px;
    pointer-events: none;
    z-index: 0;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 32px;
    position: relative;
    z-index: 1;
}

/* Header */
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 60px;
    margin-bottom: 48px;
    position: relative;
}

header::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    width: 100%;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
}

.logo {
    display: flex;
    align-items: center;
    gap: 14px;
}

.logo-icon {
    width: 52px;
    height: 52px;
    border-radius: 14px;
    background: var(--gradient-1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 26px;
    box-shadow: 0 12px 40px var(--accent-glow);
}

.logo-text {
    font-size: 1.8rem;
    font-weight: 700;
    background: var(--gradient-1);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.logo-subtitle {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.12em;
}

.status-pill {
    padding: 12px 22px;
    border-radius: 999px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    backdrop-filter: blur(12px);
    display: flex;
    align-items: center;
    gap: 10px;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--error);
}

.status-indicator.connected {
    background: var(--success);
    box-shadow: 0 0 14px rgba(34,197,94,0.6);
}

/* Cards (global glass) */
.stat-card,
.track-card,
.device-card,
.modal {
    background:
        linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01)),
        var(--bg-card);
    backdrop-filter: blur(14px);
    border: 1px solid var(--border);
    box-shadow:
        0 0 0 1px rgba(255,255,255,0.04),
        0 24px 60px rgba(0,0,0,0.45);
}

/* Stats */
.stats-bar {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
    gap: 20px;
    margin-bottom: 48px;
}

.stat-card {
    padding: 24px;
    border-radius: 18px;
    transition: all .3s ease;
}

.stat-card:hover {
    box-shadow:
        0 0 0 1px rgba(124,124,255,.35),
        0 30px 80px rgba(124,124,255,.18);
    transform: translateY(-4px);
}

.stat-label {
    font-size: .75rem;
    text-transform: uppercase;
    color: var(--text-muted);
}

.stat-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.8rem;
    margin-top: 6px;
}

.stat-value .unit {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-left: 6px;
}

.stat-trend {
    font-size: 0.75rem;
    color: var(--success);
    margin-top: 8px;
}

.stat-trend.warning { color: var(--warning); }
.stat-trend.error { color: var(--error); }

/* Sections */
.section {
    margin-bottom: 48px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 22px;
}

.section-title {
    font-size: 1.2rem;
    font-weight: 600;
    letter-spacing: 0.01em;
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-title::before {
    content: '';
    width: 4px;
    height: 18px;
    background: var(--gradient-1);
    border-radius: 2px;
}

/* Buttons */
.btn {
    border-radius: 12px;
    padding: 12px 26px;
    border: none;
    font-family: inherit;
    cursor: pointer;
    font-weight: 500;
}

.btn-primary {
    background: var(--gradient-1);
    color: #fff;
    box-shadow: 0 14px 40px var(--accent-glow);
    position: relative;
    overflow: hidden;
}

.btn-primary::after {
    content:'';
    position:absolute;
    inset:0;
    background: radial-gradient(circle at top, rgba(255,255,255,.35), transparent 60%);
    opacity:0;
    transition:.3s;
}

.btn-primary:hover::after { opacity:1; }

.btn-secondary {
    background: var(--bg-elevated);
    color: var(--text-primary);
    border: 1px solid var(--border);
}

.btn-secondary:hover {
    border-color: var(--border-hover);
    box-shadow: 0 0 0 1px rgba(255,255,255,0.08);
}

.btn-icon {
    width: 40px;
    height: 40px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
}

.btn-ghost {
    background: transparent;
    color: var(--text-secondary);
}

.btn-ghost:hover {
    background: rgba(255,255,255,0.08);
    color: var(--text-primary);
}

/* Track detail blocks */
.track-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 18px;
}

.track-info { flex: 1; }

.track-name {
    font-size: 1.1rem;
    font-weight: 600;
}

.track-id {
    margin-top: 6px;
    display: inline-block;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    color: var(--text-muted);
    background: rgba(255,255,255,0.06);
    padding: 2px 8px;
    border-radius: 6px;
}

.track-actions {
    display: flex;
    gap: 8px;
}

.device-select-wrapper { margin-bottom: 16px; }

.device-select-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    display: block;
    margin-bottom: 8px;
}

.device-select {
    width: 100%;
    padding: 12px 14px;
    border-radius: 12px;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    color: var(--text-primary);
    font-family: inherit;
    appearance: none;
}

.track-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
}

.track-controls .btn { flex: 1; }

.btn.active {
    background: var(--accent);
    color: #fff;
}

.track-metrics {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

.metric {
    text-align: center;
    padding: 10px;
    border-radius: 12px;
    background: rgba(255,255,255,0.04);
}

.metric-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.1rem;
}

.metric-label {
    margin-top: 4px;
    font-size: 0.65rem;
    text-transform: uppercase;
    color: var(--text-muted);
}

.level-meter {
    height: 8px;
    background: rgba(255,255,255,0.06);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
}

.level-meter-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success), var(--warning), var(--error));
    transition: width 0.05s linear;
}

.level-meter-peak {
    position: absolute;
    top: 0;
    width: 2px;
    height: 100%;
    background: rgba(255,255,255,0.9);
}

/* Devices */
.devices-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 12px;
}

.device-card {
    padding: 16px 18px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.device-icon {
    width: 42px;
    height: 42px;
    border-radius: 12px;
    background: rgba(255,255,255,0.06);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
}

.device-info { flex: 1; min-width: 0; }

.device-name {
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.device-type {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.device-badge {
    font-size: 0.65rem;
    padding: 4px 10px;
    border-radius: 999px;
    background: var(--accent);
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 0.08em;
}

/* Modals */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(3, 3, 8, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
}

.modal-overlay.active {
    opacity: 1;
    visibility: visible;
}

.modal {
    width: 100%;
    max-width: 520px;
    padding: 28px;
    border-radius: 22px;
    transform: translateY(20px) scale(0.98);
    transition: transform 0.2s ease;
}

.modal-overlay.active .modal {
    transform: translateY(0) scale(1);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 22px;
}

.modal-title {
    font-size: 1.2rem;
    font-weight: 600;
}

.form-group { margin-bottom: 16px; }

.form-label {
    display: block;
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 8px;
}

.form-input,
.form-select {
    width: 100%;
    padding: 12px 14px;
    border-radius: 12px;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    color: var(--text-primary);
    font-family: inherit;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
}

.form-checkbox {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-secondary);
}

.form-checkbox input { accent-color: var(--accent); }

.modal-actions {
    margin-top: 22px;
    display: flex;
    gap: 12px;
}

.modal-actions .btn { flex: 1; }

.empty-state-icon { font-size: 2.6rem; margin-bottom: 10px; opacity: 0.7; }
.empty-state-title { font-size: 1.05rem; color: var(--text-secondary); margin-bottom: 6px; }
.empty-state-text { font-size: 0.85rem; }

.loading {
    background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.12), rgba(255,255,255,0.06));
    background-size: 200% 100%;
    animation: shimmer 1.6s infinite;
}

/* Track cards */
.tracks-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px,1fr));
    gap: 24px;
}

.track-card {
    padding: 26px;
    border-radius: 22px;
    transition: all .3s ease;
    position: relative;
}

.track-card:hover {
    transform: translateY(-6px);
    box-shadow:
        0 0 0 1px rgba(124,124,255,.4),
        0 40px 100px rgba(124,124,255,.18);
}

/* Empty */
.empty-state {
    text-align: center;
    padding: 70px;
    color: var(--text-muted);
}

/* Responsive */
@media (max-width: 768px) {
    header {
        flex-direction: column;
        gap: 24px;
        text-align: center;
    }
    .tracks-grid {
        grid-template-columns: 1fr;
    }
}
</style>
</head>

<body>
<div class="bg-gradient"></div>
<div class="grid-overlay"></div>

<div class="container">

<header>
    <div class="logo">
        <div class="logo-icon">üéµ</div>
        <div>
            <div class="logo-text">LAN Audio Streamer</div>
            <div class="logo-subtitle" id="modeLabel">Initializing‚Ä¶</div>
        </div>
    </div>
    <div class="status-pill">
        <div class="status-indicator" id="connectionStatus"></div>
        <span id="connectionText">Connecting‚Ä¶</span>
    </div>
</header>
        
        <!-- Global Stats -->
        <div class="stats-bar" id="statsBar">
            <div class="stat-card">
                <div class="stat-label">Total Packets</div>
                <div class="stat-value" id="totalPackets">0</div>
                <div class="stat-trend" id="packetsTrend">Waiting...</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Data Transfer</div>
                <div class="stat-value" id="dataTransfer">0<span class="unit">KB</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Latency</div>
                <div class="stat-value" id="avgLatency">--<span class="unit">ms</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Packet Loss</div>
                <div class="stat-value" id="packetLoss">0<span class="unit">%</span></div>
            </div>
        </div>
        
        <!-- Tracks Section -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Audio Tracks</h2>
                <button class="btn btn-primary" onclick="showAddTrackModal()">
                    <span>+</span> Add Track
                </button>
            </div>
            <div id="tracksContainer" class="tracks-grid">
                <div class="empty-state">
                    <div class="empty-state-icon">üéß</div>
                    <div class="empty-state-title">No tracks configured</div>
                    <div class="empty-state-text">Click "Add Track" to start streaming audio</div>
                </div>
            </div>
        </div>
        
        <!-- Devices Section -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Audio Devices</h2>
                <button class="btn btn-secondary" onclick="refreshDevices()">
                    ‚Üª Refresh
                </button>
            </div>
            <div id="devicesContainer" class="devices-grid">
                <div class="empty-state loading" style="grid-column: 1/-1; padding: 40px;">
                    Loading devices...
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Track Modal -->
    <div class="modal-overlay" id="addTrackModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Create New Track</h3>
                <button class="btn btn-icon btn-ghost" onclick="hideAddTrackModal()">‚úï</button>
            </div>
            <form id="addTrackForm" onsubmit="createTrack(event)">
                <div class="form-group">
                    <label class="form-label">Track Name</label>
                    <input type="text" class="form-input" id="trackName" placeholder="My Audio Track" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Audio Device</label>
                    <select class="form-select" id="trackDevice" required>
                        <option value="">Select device...</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Bitrate</label>
                        <select class="form-select" id="trackBitrate">
                            <option value="32000">32 kbps</option>
                            <option value="64000">64 kbps</option>
                            <option value="96000">96 kbps</option>
                            <option value="128000" selected>128 kbps</option>
                            <option value="192000">192 kbps</option>
                            <option value="256000">256 kbps</option>
                            <option value="320000">320 kbps</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Frame Size</label>
                        <select class="form-select" id="trackFrameSize">
                            <option value="2.5">2.5 ms</option>
                            <option value="5">5 ms</option>
                            <option value="10" selected>10 ms</option>
                            <option value="20">20 ms</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Track Type</label>
                        <select class="form-select" id="trackType">
                            <option value="Music">Music</option>
                            <option value="Voice">Voice</option>
                            <option value="LowLatency">Low Latency</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Channels</label>
                        <select class="form-select" id="trackChannels">
                            <option value="1">Mono</option>
                            <option value="2" selected>Stereo</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="trackFec">
                        Enable FEC (Forward Error Correction)
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideAddTrackModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Track</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Track Modal -->
    <div class="modal-overlay" id="editTrackModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Edit Track</h3>
                <button class="btn btn-icon btn-ghost" onclick="hideEditTrackModal()">‚úï</button>
            </div>
            <form id="editTrackForm" onsubmit="saveTrackSettings(event)">
                <input type="hidden" id="editTrackId">
                <div class="form-group">
                    <label class="form-label">Track Name</label>
                    <input type="text" class="form-input" id="editTrackName" placeholder="Track name">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Bitrate</label>
                        <select class="form-select" id="editTrackBitrate">
                            <option value="32000">32 kbps</option>
                            <option value="64000">64 kbps</option>
                            <option value="96000">96 kbps</option>
                            <option value="128000">128 kbps</option>
                            <option value="192000">192 kbps</option>
                            <option value="256000">256 kbps</option>
                            <option value="320000">320 kbps</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Frame Size</label>
                        <select class="form-select" id="editTrackFrameSize">
                            <option value="2.5">2.5 ms</option>
                            <option value="5">5 ms</option>
                            <option value="10">10 ms</option>
                            <option value="20">20 ms</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="editTrackFec">
                        Enable FEC (Forward Error Correction)
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideEditTrackModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // State
        let ws = null;
        let tracks = [];
        let devices = [];
        let isReceiver = false;
        let totalPackets = 0;
        let lastPacketCount = 0;
        let packetRate = 0;
        let peakLevels = {};
        
        // WebSocket
        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            
            ws.onopen = () => {
                document.getElementById('connectionStatus').classList.add('connected');
                document.getElementById('connectionText').textContent = 'Connected';
                ws.send(JSON.stringify({ type: 'GetStatus' }));
                ws.send(JSON.stringify({ type: 'ListDevices' }));
            };
            
            ws.onclose = () => {
                document.getElementById('connectionStatus').classList.remove('connected');
                document.getElementById('connectionText').textContent = 'Reconnecting...';
                setTimeout(connect, 2000);
            };
            
            ws.onerror = (err) => console.error('WebSocket error:', err);
            
            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    handleMessage(msg);
                } catch (e) {
                    console.error('Failed to parse message:', e);
                }
            };
        }
        
        function handleMessage(msg) {
            switch (msg.type) {
                case 'Status':
                    tracks = msg.data || [];
                    renderTracks();
                    updateGlobalStats();
                    break;
                case 'Devices':
                    devices = msg.data.devices || [];
                    isReceiver = msg.data.is_receiver;
                    document.getElementById('modeLabel').textContent = isReceiver ? 'RECEIVER MODE' : 'SENDER MODE';
                    renderDevices();
                    updateDeviceSelects();
                    break;
                case 'Error':
                    showNotification(msg.data.message, 'error');
                    break;
            }
        }
        
        function updateGlobalStats() {
            let packets = 0;
            let lost = 0;
            let latencySum = 0;
            let latencyCount = 0;
            
            tracks.forEach(track => {
                packets += (track.packets_sent || 0) + (track.packets_received || 0);
                lost += track.packets_lost || 0;
                if (track.current_latency_ms > 0) {
                    latencySum += track.current_latency_ms;
                    latencyCount++;
                }
            });
            
            // Packet rate
            packetRate = packets - lastPacketCount;
            lastPacketCount = packets;
            
            document.getElementById('totalPackets').textContent = formatNumber(packets);
            document.getElementById('packetsTrend').textContent = `${packetRate >= 0 ? '+' : ''}${packetRate}/s`;
            document.getElementById('packetsTrend').className = 'stat-trend ' + (packetRate > 0 ? '' : 'warning');
            
            // Data transfer (rough estimate: ~100 bytes per packet average)
            const dataKB = (packets * 100) / 1024;
            document.getElementById('dataTransfer').innerHTML = dataKB >= 1024 
                ? `${(dataKB/1024).toFixed(1)}<span class="unit">MB</span>`
                : `${dataKB.toFixed(0)}<span class="unit">KB</span>`;
            
            // Latency
            const avgLatency = latencyCount > 0 ? (latencySum / latencyCount) : 0;
            document.getElementById('avgLatency').innerHTML = avgLatency > 0 
                ? `${avgLatency.toFixed(1)}<span class="unit">ms</span>`
                : `--<span class="unit">ms</span>`;
            
            // Packet loss
            const totalPackets = packets + lost;
            const lossRate = totalPackets > 0 ? ((lost / totalPackets) * 100) : 0;
            document.getElementById('packetLoss').innerHTML = `${lossRate.toFixed(1)}<span class="unit">%</span>`;
        }
        
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }
        
        function renderTracks() {
            const container = document.getElementById('tracksContainer');
            
            if (!tracks || tracks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-state-icon">üéß</div>
                        <div class="empty-state-title">No tracks configured</div>
                        <div class="empty-state-text">Click "Add Track" to start streaming audio</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = tracks.map(track => {
                const packets = track.packets_sent || track.packets_received || 0;
                const latency = track.current_latency_ms || 0;
                const jitter = track.jitter_ms || 0;
                const level = track.level_db || -96;
                
                // Calculate meter width (dB to percentage, -60dB to 0dB range)
                const meterWidth = Math.max(0, Math.min(100, (level + 60) / 60 * 100));
                
                // Store peak for decay
                if (!peakLevels[track.track_id]) peakLevels[track.track_id] = -96;
                if (level > peakLevels[track.track_id]) {
                    peakLevels[track.track_id] = level;
                } else {
                    peakLevels[track.track_id] = Math.max(level, peakLevels[track.track_id] - 1);
                }
                const peakWidth = Math.max(0, Math.min(100, (peakLevels[track.track_id] + 60) / 60 * 100));
                
                return `
                    <div class="track-card ${track.active ? 'active' : ''}">
                        <div class="track-header">
                            <div class="track-info">
                                <div class="track-name">${escapeHtml(track.name)}</div>
                                <span class="track-id">Track #${track.track_id}</span>
                            </div>
                            <div class="track-actions">
                                <button class="btn btn-icon btn-ghost" onclick="showEditTrackModal(${track.track_id})" title="Settings">‚öôÔ∏è</button>
                                <button class="btn btn-icon btn-ghost" onclick="deleteTrack(${track.track_id})" title="Delete">üóëÔ∏è</button>
                            </div>
                        </div>
                        
                        <div class="device-select-wrapper">
                            <label class="device-select-label">Audio Device</label>
                            <select class="device-select" onchange="changeTrackDevice(${track.track_id}, this.value)">
                                ${getDeviceOptions(track.device_id)}
                            </select>
                        </div>
                        
                        <div class="track-controls">
                            <button class="btn btn-secondary ${track.muted ? 'active' : ''}" onclick="toggleMute(${track.track_id}, ${!track.muted})">
                                ${track.muted ? 'üîá Muted' : 'üîä Mute'}
                            </button>
                            <button class="btn btn-secondary ${track.solo ? 'active' : ''}" onclick="toggleSolo(${track.track_id}, ${!track.solo})">
                                üéØ Solo
                            </button>
                        </div>
                        
                        <div class="track-metrics">
                            <div class="metric">
                                <div class="metric-value">${formatNumber(packets)}</div>
                                <div class="metric-label">Packets</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${latency > 0 ? latency.toFixed(1) : '--'}</div>
                                <div class="metric-label">Latency ms</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${jitter > 0 ? jitter.toFixed(1) : '--'}</div>
                                <div class="metric-label">Jitter ms</div>
                            </div>
                        </div>
                        
                        <div class="level-meter">
                            <div class="level-meter-fill" style="width: ${meterWidth}%"></div>
                            <div class="level-meter-peak" style="left: ${peakWidth}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderDevices() {
            const container = document.getElementById('devicesContainer');
            
            if (!devices || devices.length === 0) {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;">No audio devices found</div>';
                return;
            }
            
            container.innerHTML = devices.map(device => {
                const icon = device.is_input ? 'üé§' : 'üîä';
                const type = device.is_input && device.is_output ? 'Input/Output' 
                           : device.is_input ? 'Input' : 'Output';
                return `
                    <div class="device-card">
                        <div class="device-icon">${icon}</div>
                        <div class="device-info">
                            <div class="device-name">${escapeHtml(device.name)}</div>
                            <div class="device-type">${type}</div>
                        </div>
                        ${device.is_default ? '<span class="device-badge">Default</span>' : ''}
                    </div>
                `;
            }).join('');
        }
        
        function updateDeviceSelects() {
            const select = document.getElementById('trackDevice');
            const filtered = isReceiver 
                ? devices.filter(d => d.is_output) 
                : devices.filter(d => d.is_input);
            
            select.innerHTML = '<option value="">Select device...</option>' +
                filtered.map(d => `<option value="${d.id}">${escapeHtml(d.name)}${d.is_default ? ' (Default)' : ''}</option>`).join('');
        }
        
        function getDeviceOptions(selectedId) {
            const filtered = isReceiver 
                ? devices.filter(d => d.is_output) 
                : devices.filter(d => d.is_input);
            
            return filtered.map(d => 
                `<option value="${d.id}" ${d.id === selectedId ? 'selected' : ''}>${escapeHtml(d.name)}${d.is_default ? ' (Default)' : ''}</option>`
            ).join('');
        }
        
        // Modals
        function showAddTrackModal() {
            document.getElementById('addTrackModal').classList.add('active');
        }
        
        function hideAddTrackModal() {
            document.getElementById('addTrackModal').classList.remove('active');
            document.getElementById('addTrackForm').reset();
        }
        
        function showEditTrackModal(trackId) {
            const track = tracks.find(t => t.track_id === trackId);
            if (!track) return;
            
            document.getElementById('editTrackId').value = trackId;
            document.getElementById('editTrackName').value = track.name || '';
            document.getElementById('editTrackBitrate').value = track.bitrate || 128000;
            document.getElementById('editTrackFrameSize').value = track.frame_size_ms || 10;
            document.getElementById('editTrackFec').checked = track.fec_enabled || false;
            
            document.getElementById('editTrackModal').classList.add('active');
        }
        
        function hideEditTrackModal() {
            document.getElementById('editTrackModal').classList.remove('active');
        }
        
        // Actions
        function createTrack(event) {
            event.preventDefault();
            
            const config = {
                name: document.getElementById('trackName').value,
                device_id: document.getElementById('trackDevice').value,
                bitrate: parseInt(document.getElementById('trackBitrate').value),
                frame_size_ms: parseFloat(document.getElementById('trackFrameSize').value),
                channels: parseInt(document.getElementById('trackChannels').value),
                track_type: document.getElementById('trackType').value,
                fec_enabled: document.getElementById('trackFec').checked
            };
            
            ws.send(JSON.stringify({ type: 'CreateTrack', data: config }));
            hideAddTrackModal();
            setTimeout(() => ws.send(JSON.stringify({ type: 'GetStatus' })), 500);
        }
        
        function saveTrackSettings(event) {
            event.preventDefault();
            
            const trackId = parseInt(document.getElementById('editTrackId').value);
            const config = {};
            
            const name = document.getElementById('editTrackName').value;
            if (name) config.name = name;
            
            const bitrate = document.getElementById('editTrackBitrate').value;
            if (bitrate) config.bitrate = parseInt(bitrate);
            
            const frameSize = document.getElementById('editTrackFrameSize').value;
            if (frameSize) config.frame_size_ms = parseFloat(frameSize);
            
            config.fec_enabled = document.getElementById('editTrackFec').checked;
            
            ws.send(JSON.stringify({ type: 'UpdateTrack', data: { track_id: trackId, config } }));
            hideEditTrackModal();
            setTimeout(() => ws.send(JSON.stringify({ type: 'GetStatus' })), 500);
        }
        
        function deleteTrack(trackId) {
            if (confirm('Delete this track?')) {
                ws.send(JSON.stringify({ type: 'RemoveTrack', data: { track_id: trackId } }));
                setTimeout(() => ws.send(JSON.stringify({ type: 'GetStatus' })), 500);
            }
        }
        
        function toggleMute(trackId, muted) {
            ws.send(JSON.stringify({ type: 'SetMute', data: { track_id: trackId, muted } }));
            setTimeout(() => ws.send(JSON.stringify({ type: 'GetStatus' })), 100);
        }
        
        function toggleSolo(trackId, solo) {
            ws.send(JSON.stringify({ type: 'SetSolo', data: { track_id: trackId, solo } }));
            setTimeout(() => ws.send(JSON.stringify({ type: 'GetStatus' })), 100);
        }
        
        function changeTrackDevice(trackId, deviceId) {
            if (!deviceId) return;
            ws.send(JSON.stringify({ type: 'UpdateTrack', data: { track_id: trackId, config: { device_id: deviceId } } }));
            setTimeout(() => ws.send(JSON.stringify({ type: 'GetStatus' })), 500);
        }
        
        function refreshDevices() {
            ws.send(JSON.stringify({ type: 'ListDevices' }));
        }
        
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
        
        function showNotification(message, type = 'info') {
            console.log(`[${type}] ${message}`);
            // Could add a toast notification UI here
        }
        
        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });
        
        // Close modals on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
            }
        });
        
        // Periodic status update
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'GetStatus' }));
            }
        }, 1000);
        
        // Init
        connect();
    </script>
</body>
</html>
